
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Melting time</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="description" content="">
	<meta name="author" content="">

	<!-- Le styles -->
	<link href="css/bootstrap.css" rel="stylesheet">

	<style>
		html {
			/*background:#87ba4f;*/
			background:#4c9d51;
		}
		
		body {
			background-image:url('img/background.svg');
			background-size:cover;
			background-repeat:no-repeat;
		}
		
		#header {
			margin: 20px 0;
		} 
		
		#footer {
			position: fixed;
			bottom: 0;
		}
		
		.popover {
			width: 600px;
		}
		
		h1 {
			font-size: 64pt;
			line-height: 70pt;
		}
		
		#icecream-container {
			float:right;
		}
		#scoop {
			fill: #664422;
			stroke: none;
			stroke-width: 2;
			transition: fill 1s;
		}
		
		#scoop.melt
		{
			/*
			animation-name: myfirst;
			animation-duration: 10s;
			animation-timing-function: linear;
			*/
			-webkit-animation-name: melting;
			-webkit-animation-duration: 10s;
			-webkit-animation-timing-function: linear;
		}
		@keyframes melt
		{
			0%   {
				transform: scale(1,1) translate(0px, 0px);
			}
			100% {
				transform: scale(.75,.2) translate(0px, 5px);
			}
		}
		@-webkit-keyframes melt
		{
			0%   {
				-webkit-transform: scale(1,1) translate(0px, 0px);
			}
			100% {
				-webkit-transform: scale(.75,.2) translate(0px, 5px);
			}
		}
		
		
	</style>

	<!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
		<!--[if lt IE 9]>
		<script src="../assets/js/html5shiv.js"></script>
	<![endif]-->

	<!-- Fav and touch icons -->
	<!--
	<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
	<link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
	<link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
	<link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">
	<link rel="shortcut icon" href="../assets/ico/favicon.png">
	-->

</head>

<body>

	<div class="container">
	
		<div class="row-fluid">
		
			<div class="span8">
			
				<h1>Finding you…</h1>
				
				<div class="btn-toolbar">
					<div class="btn-group control-buttons" data-toggle="buttons-radio" id="flavor">
					<button class="btn btn-large active" data-flavor="chocolate">Chocolate</button>
					<button class="btn btn-large" data-flavor="coffee">Coffee</button>
					<button class="btn btn-large" data-flavor="vanilla">Vanilla</button>
					</div>
				</div>

				<div class="btn-toolbar">
					<div class="btn-group control-buttons" data-toggle="buttons-radio" id="scoopsize">
					<button class="btn btn-large" data-scoopsize="treat">Treat</button>
					<button class="btn btn-large" data-scoopsize="small">Small</button>
					<button class="btn btn-large" data-scoopsize="medium">Medium</button>
					<button class="btn btn-large" data-scoopsize="large">Large</button>
					</div>
				</div>
				
				<p id="notifications"></p>
				
				<div id="data-stats" style="opacity:.4">
					<p>Location: <span id="data-loc"></span></p>
					<p>Temperature: <span id="data-temp"></span>ºF</p>
					<p>Cloud cover: <span id="data-cloud"></span>%</p>
					<p>Wind: <span id="data-wind"></span> mph</p>
					<p>Precipitation intensity: <span id="data-precip"></span></p>
					<p>Precipitation probability: <span id="data-precipprob"></span>%</p>
				</div>
			
			</div>
			
			<div class="span4" id="icecream-container">
				<svg id="icecream-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.0" id="Layer_2" x="0px" y="0px" height="100%" viewBox="21.276 -4.342 56.448 100" enable-background="new 21.276 -4.342 56.448 100" xml:space="preserve">
					<rect x="49.426" y="63.556" transform="matrix(0.4226 0.9063 -0.9063 0.4226 90.9679 -9.1559)" width="6.487" height="6.518"/>
					<polygon points="58.946,67.468 61.234,59.725 61.05,59.33 55.156,62.078 57.897,67.956 "/>
					<polygon points="36.185,54.375 38.043,60.665 43.844,57.961 41.103,52.082 "/>
					<polygon points="40.645,68.845 40.483,68.921 42.341,75.21 43.385,74.723 "/>
					<rect x="42.622" y="66.737" transform="matrix(0.4227 0.9063 -0.9063 0.4227 89.91 -1.1597)" width="6.486" height="6.503"/>
					<rect x="53.503" y="36.832" transform="matrix(-0.4226 -0.9063 0.9063 -0.4226 44.4204 108.4666)" width="6.519" height="6.503"/>
					<polygon points="61.532,58.005 61.776,57.89 64.24,49.55 58.777,52.096 "/>
					<rect x="46.714" y="39.993" transform="matrix(-0.9063 0.4227 -0.4227 -0.9063 113.5303 61.3331)" width="6.503" height="6.519"/>
					<rect x="39.902" y="43.166" transform="matrix(-0.4226 -0.9063 0.9063 -0.4226 19.3251 105.1619)" width="6.519" height="6.519"/>
					<rect x="56.689" y="43.629" transform="matrix(-0.4226 -0.9063 0.9063 -0.4226 42.7729 121.0088)" width="6.486" height="6.503"/>
					<polygon points="58.319,68.86 58.451,69.143 58.569,68.743 "/>
					<polygon points="40.197,67.953 40.223,67.941 40.143,67.769 "/>
					<rect x="39.437" y="59.94" transform="matrix(0.4227 0.9063 -0.9063 0.4227 81.9202 -2.2115)" width="6.518" height="6.503"/>
					<rect x="43.087" y="49.962" transform="matrix(-0.4226 -0.9063 0.9063 -0.4226 17.6737 117.7036)" width="6.487" height="6.519"/>
					<path d="M49.802,32.848l2.215,4.751l5.894-2.748l-1.227-2.63c-0.69-0.278-1.346-0.644-1.95-1.095  C53.309,32.189,51.604,32.788,49.802,32.848z"/>
					<rect x="49.892" y="46.797" transform="matrix(-0.4225 -0.9063 0.9063 -0.4225 30.2246 119.3553)" width="6.486" height="6.503"/>
					<rect x="46.241" y="56.759" transform="matrix(0.4226 0.9063 -0.9063 0.4226 82.978 -10.2077)" width="6.519" height="6.52"/>
					<rect x="53.045" y="53.596" transform="matrix(0.4226 0.9063 -0.9063 0.4226 84.031 -18.2062)" width="6.519" height="6.502"/>
					<polygon points="64.87,47.418 67.069,39.973 62.411,42.145 "/>
					<path d="M49.5,95.658c0.664,0,1.246-0.436,1.435-1.072l0.664-2.249l-1.453-3.115l-3.221,1.502l1.141,3.862  C48.254,95.222,48.836,95.658,49.5,95.658z"/>
					<polygon points="46.983,82.439 44.781,83.467 46.639,89.757 49.725,88.318 "/>
					<polygon points="31.888,39.829 33.746,46.119 37.504,44.366 34.764,38.488 "/>
					<rect x="36.732" y="36.385" transform="matrix(-0.9063 0.4226 -0.4226 -0.9063 92.9837 58.6434)" width="6.519" height="6.486"/>
					<path d="M31.602,38.862l2.74-1.278l-2.5-5.361c-0.652,0.262-1.336,0.446-2.041,0.544L31.602,38.862z"/>
					<path d="M41.154,34.408l-0.772-1.657c-0.442,0.067-0.892,0.103-1.348,0.103c-1.915,0-3.73-0.606-5.234-1.729  c-0.336,0.251-0.69,0.473-1.056,0.671l2.502,5.366L41.154,34.408z"/>
					<polygon points="54.809,81.473 53.78,79.269 47.887,82.017 50.628,87.896 53.275,86.662 "/>
					<path d="M41.382,32.537l0.676,1.449l3.961-1.847c-0.618-0.267-1.206-0.606-1.752-1.014C43.396,31.776,42.42,32.251,41.382,32.537z"/>
					<path d="M68.08,36.554l1.119-3.788c-0.939-0.131-1.841-0.413-2.679-0.831l-0.488,0.228L68.08,36.554z"/>
					<polygon points="51.05,88.8 52.025,90.893 52.898,87.937 "/>
					<polygon points="56.105,77.085 58.024,70.588 57.416,69.281 51.508,72.037 54.263,77.944 "/>
					<polygon points="55.728,78.361 54.684,78.847 55.235,80.029 "/>
					<rect x="45.776" y="73.534" transform="matrix(0.4228 0.9062 -0.9062 0.4228 97.8895 -0.1149)" width="6.518" height="6.502"/>
					<path d="M45.22,40.768l5.893-2.748l-2.427-5.205c-0.44-0.04-0.874-0.111-1.297-0.215l-4.91,2.29L45.22,40.768z"/>
					<polygon points="43.807,75.628 42.627,76.177 44.495,82.499 46.562,81.535 "/>
					<path d="M57.973,32.627l0.841,1.803l5.894-2.748l-0.076-0.164c-1.383,0.871-2.984,1.337-4.663,1.337  C59.286,32.854,58.619,32.776,57.973,32.627z"/>
					<polygon points="34.032,47.086 35.899,53.408 40.681,51.178 37.926,45.27 "/>
					<polygon points="59.235,35.333 61.99,41.242 67.446,38.698 67.653,37.999 65.129,32.585 "/>
					<g id="scoop">
						<path d="M73.323,17.376C72.209,5.197,61.969-4.342,49.5-4.342S26.792,5.197,25.677,17.376c-2.589,1.119-4.401,3.694-4.401,6.693   c0,4.026,3.264,7.29,7.29,7.29c2.054,0,3.909-0.851,5.233-2.218c1.325,1.367,3.18,2.218,5.234,2.218s3.909-0.851,5.233-2.218   c1.325,1.367,3.18,2.218,5.234,2.218s3.909-0.851,5.233-2.218c1.325,1.367,3.18,2.218,5.234,2.218c2.054,0,3.908-0.851,5.233-2.218   c1.325,1.367,3.18,2.218,5.233,2.218c4.026,0,7.29-3.263,7.29-7.29C77.725,21.07,75.912,18.494,73.323,17.376z"/>
					</g>
				</svg>
			</div>
		
		</div>
		
		<div id="footer">
			
			<p>
				<button id="data-popover-button" class="btn btn-success" data-title="Data" data-placement="top">Data</button> 
				<button id="colophon-popover-button" class="btn btn-success" data-title="Colophon" data-placement="top" data-content="Coded by Toph Tucker. Illustrated by Aaron Wolf. Inspired by licking a coffee ice cream cone from the little shop down Anderson Alley in Concord, MA on Friday, June 5, temperature 91ºF.">Colophon</button>
			</p>
			
		</div>

	</div> <!-- /container -->

	<!-- Le javascript
	================================================== -->
	<!-- Placed at the end of the document so the pages load faster -->
	<script src="http://code.jquery.com/jquery.js"></script>
	<script src="js/bootstrap.js"></script>

	<script>
	var forecastAPIkey = 'ddfdd44606f4fb476c0c7fec167bf4a0';
	var userLat;
	var userLong; 
	
	//from http://javascript.about.com/library/bldayyear.htm, of all places
	Date.prototype.getDOY = function() {
		var onejan = new Date(this.getFullYear(),0,1);
		return Math.ceil((this - onejan) / 86400000);
	}
	
	Date.prototype.getJulian = function() {
		//confer http://stackoverflow.com/questions/11759992/calculating-jdayjulian-day-in-javascript
		//this commented-out version gives an integer local Julian Date
		//return Math.floor((this / 86400000) - (this.getTimezoneOffset()/1440) + 2440587.5);
		//this returns a UTC Julian Date with fraction:
		return (this.getTime()/86400000 + 2440587.5);
	}
	
	Date.prototype.getDayFraction = function() {
		return (this.getHours()+(this.getMinutes()/60)+(this.getSeconds()/3600))/24;
	}
	
	Date.prototype.getSidereal = function(j2kDate, longitude) {
		
		// Greenwich mean sidereal time
		// from http://stackoverflow.com/questions/257717/position-of-the-sun-given-time-of-day-and-lat-long
		var gmst = 6.697375 + .0657098242 * j2kDate; // + this.getDayFraction()/24 + 0.5
			gmst = gmst % 24;
		console.log("GMST 1: " + gmst);
		
		// from http://aa.usno.navy.mil/faq/docs/GAST.php; doesn't seem to work?
		/* var gmst2 = 18.697374558 + 24.06570982441908 * j2kDate; // + this.getDayFraction()/24 + 0.5 // +(4/24)+0.5 //???
			gmst2 = gmst2 % 24;
		console.log("GMST 2: " + gmst2); */
		
		// Local mean sidereal time
		// appears to work with gmst-long even though long was already negative for boston and i thought that was right...
		var lmst = gmst - (longitude / (360/24)); //converting longitude from degrees (out of 360) to hours (out of 24)
			lmst = lmst % 24;
			//lmst = lmst * 15 * (Math.PI/180);
		
		console.log("LMST: " + lmst);
		
		return lmst;
	}
	
	function getSolarElevation(latitude, longitude)
	{
		
		// first get ecliptic mean longitude and mean anomaly
		// adapted from R: http://stackoverflow.com/a/258106/120290
		// http://en.wikipedia.org/wiki/Position_of_the_Sun
		// http://en.wikipedia.org/wiki/Solar_zenith_angle
		
		var degToRad = Math.PI/180;
		
		var today = new Date();
		var julianDate		= today.getJulian();
		var j2kDate 		= julianDate - 2451545; // epoch: noon, 1 January 2000
		var siderealTime	= today.getSidereal(j2kDate, longitude); // local mean sidereal time
		
		console.log("Julian date: " + julianDate);
		console.log("J2K date: " + j2kDate);
		console.log("siderealTime: " + siderealTime);
		/*
		var eclipticMeanLongitude = 280.460 + .9856474 * j2kDate;
		eclipticMeanLongitude = eclipticMeanLongitude % 360;
		
		var eclipticMeanAnomaly = 357.528 + .9856003 * j2kDate;
		eclipticMeanAnomaly = eclipticMeanAnomaly % 360;
		
		var eclipticLongitude = eclipticMeanLongitude + 1.915*Math.sin(degToRad*eclipticMeanAnomaly) + 0.020*Math.sin(degToRad*2*eclipticMeanAnomaly);
		eclipticLongitude = eclipticLongitude % 360;
		
		var rightAscension 	= Math.asin(Math.cos(degToRad*-23.44)*Math.tan(degToRad*eclipticLongitude));
		var declination 	= Math.asin(Math.sin(degToRad*-23.44)*Math.sin(degToRad*eclipticLongitude));
		
		var hourAngle = siderealTime - rightAscension;
		
		var elevation = Math.asin(Math.sin(declination) * sin(degToRad*latitude) + cos(declination) * Math.cos(degToRad*latitude) * Math.cos(hourAngle));
		var azimuth = Math.asin(-Math.cos(declination) * sin(hourAngle) / cos(elevation));*/
		
		return true;
	}
	
	var x=document.getElementById("data-loc");
	function getLocation()
	{
		if (navigator.geolocation) 
		{
			navigator.geolocation.getCurrentPosition(showPosition);
		}
		else 
		{
			x.innerHTML="Geolocation is not supported by this browser.";
		}
	}
	function showPosition(position)
	{
		console.log(position);
		userLat = position.coords.latitude;
		userLong = position.coords.longitude;
		
		getSolarElevation(userLat, userLong);
		
		x.innerHTML=Math.round(userLat*100)/100 + ", " + Math.round(userLong*100)/100;	
		
		$.ajax({
			type: "GET",
			url: "https://api.forecast.io/forecast/"+forecastAPIkey+"/"+userLat+","+userLong,
			dataType: 'jsonp',
			success: function(result){
				
				var temp = result.currently.temperature;
				
				$("#data-temp").html(Math.round(temp));
				$("#data-cloud").html(result.currently.cloudCover*100);
				$("#data-wind").html(result.currently.windSpeed);
				$("#data-precip").html(result.currently.precipIntensity);
				$("#data-precipprob").html(result.currently.precipProbability*100);
				
				console.log(result);
				
				var meltCoef = '1000';
				var flavorCoef = '1';
				var sizeCoef = '1';
				var typeCoef = '1';
				
				var meltTime = meltCoef * flavorCoef * sizeCoef * typeCoef * (1/temp);
				var meltTimeDisplay = Math.round(meltTime);
				$("h1").html("Your ice cream will melt in " + meltTimeDisplay + " minutes.");
				
			},
			error: function(XMLHttpRequest, textStatus, errorThrown){
				$("#notifications").html("There was an unknown error. The site could not be reached. "+errorThrown+" "+textStatus);
			}
		});
		
	}
	
	
	
	$("#flavor button").click(function(event) {
		switch(event.target.dataset.flavor) {
			case "chocolate":
				var scoopFill="#664422";
				//var scoopStroke="white";
				break;
			case "coffee":
				var scoopFill="tan";
				//var scoopStroke="white";
				break;
			case "vanilla":
				var scoopFill="#f2ebe1";
				//var scoopStroke="white";
				break;
			default:
				//
		}		  
		$("#scoop").css("fill",scoopFill);
		$("#scoop").css("stroke",scoopStroke);
	});
	
	$('#data-popover-button').popover()
	
	$('#colophon-popover-button').popover()
	
	$(document).ready(function() {
		
		getLocation();
		
	});
	
	
	
	</script>

</body>
</html>